name: demos-release-dist-tag

on:
  push:
    tags:
      - "latest"
      - "next"
  workflow_dispatch:
    inputs:
      dist_tag:
        description: "Dist tag to update (latest or next)"
        required: true
        type: choice
        options:
          - latest
          - next

permissions:
  contents: write
  pages: write

jobs:
  update-dist-tag-content:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build Polen
        run: pnpm build

      - name: Get dist-tag info
        id: dist-tag
        uses: ./.github/actions/run-workflow-step
        with:
          step: demos-release-dist-tag/get-dist-tag-info.ts
          inputs: |
            {
              "github_event_name": "${{ github.event_name }}",
              "input_dist_tag": "${{ inputs.dist_tag }}",
              "github_ref": "${{ github.ref }}"
            }

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Update dist-tag content
        uses: ./.github/actions/run-workflow-step
        with:
          step: demos-release-dist-tag/update-dist-tag-content.ts
          inputs: |
            {
              "tag_name": "${{ steps.dist-tag.outputs.tag_name }}",
              "semver_tag": "${{ steps.dist-tag.outputs.semver_tag }}"
            }

      - name: Update demos index
        uses: ./.github/actions/run-workflow-step
        with:
          step: shared/update-demos-home.ts

      - name: Configure git
        uses: ./.github/actions/configure-git

      - name: Commit and deploy
        run: |
          cd gh-pages

          git add .

          if [[ -n $(git status --porcelain) ]]; then
            git commit -m "chore: update ${{ steps.dist-tag.outputs.tag_name }} content to ${{ steps.dist-tag.outputs.semver_tag }}"
            git push origin gh-pages
          else
            echo "No changes to deploy"
          fi
