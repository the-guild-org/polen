name: demos-release-dist-tag

on:
  push:
    tags:
      - 'latest'
      - 'next'
  workflow_dispatch:
    inputs:
      dist_tag:
        description: 'Dist tag to update (latest or next)'
        required: true
        type: choice
        options:
          - latest
          - next

permissions:
  contents: write
  pages: write

jobs:
  update-redirects:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Get dist-tag info
        id: dist-tag
        run: |
          # Get the tag name from push event or manual input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ inputs.dist_tag }}"
          else
            TAG_NAME="${GITHUB_REF#refs/tags/}"
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          # Get the commit this tag points to
          COMMIT=$(git rev-list -n 1 $TAG_NAME)
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          
          # Find the semver tag for this commit
          SEMVER_TAG=$(git tag --points-at $COMMIT | grep -E '^[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          
          if [ -z "$SEMVER_TAG" ]; then
            echo "❌ No semver tag found for commit $COMMIT"
            exit 1
          fi
          
          echo "semver_tag=$SEMVER_TAG" >> $GITHUB_OUTPUT
          echo "✅ Dist-tag $TAG_NAME points to $SEMVER_TAG"

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Update dist-tag redirects
        run: |
          cd gh-pages
          
          TAG_NAME="${{ steps.dist-tag.outputs.tag_name }}"
          SEMVER_TAG="${{ steps.dist-tag.outputs.semver_tag }}"
          
          # Check if the semver deployment exists
          if [ ! -d "$SEMVER_TAG" ]; then
            echo "❌ Deployment for $SEMVER_TAG not found in gh-pages"
            echo "⚠️  This indicates the release workflow may have failed or skipped building demos"
            echo "📝 Check the release workflow run for $SEMVER_TAG"
            exit 1
          fi
          
          # Create/update dist-tag redirects
          # This handles when npm dist-tags are moved to different versions
          # Examples:
          # - /polen/latest/ → /polen/1.2.1/ (when latest tag moved from 1.2.0 to 1.2.1)
          # - /polen/next/ → /polen/1.3.0-beta.2/ (when next tag moved to newer prerelease)
          echo "Updating $TAG_NAME to point to $SEMVER_TAG"
          
          mkdir -p $TAG_NAME
          cat > $TAG_NAME/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Redirecting...</title>
            <meta http-equiv="refresh" content="0; url=/polen/$SEMVER_TAG/">
            <script>window.location.replace("/polen/$SEMVER_TAG/");</script>
          </head>
          <body>
            <p>Redirecting to <a href="/polen/$SEMVER_TAG/">/polen/$SEMVER_TAG/</a>...</p>
          </body>
          </html>
          EOF
          
          # Get list of examples from existing deployments in gh-pages
          if [ -d "$SEMVER_TAG" ]; then
            EXAMPLES=$(ls -d $SEMVER_TAG/*/ 2>/dev/null | xargs -n1 basename || echo "")
          else
            EXAMPLES=""
          fi
          
          # Create demo-specific redirects
          # Examples:
          # - /polen/latest/pokemon/ → /polen/1.2.1/pokemon/
          # - /polen/next/pokemon/ → /polen/1.3.0-beta.2/pokemon/
          for example in $EXAMPLES; do
            mkdir -p $TAG_NAME/$example
            cat > $TAG_NAME/$example/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Redirecting...</title>
            <meta http-equiv="refresh" content="0; url=/polen/$SEMVER_TAG/$example/">
            <script>window.location.replace("/polen/$SEMVER_TAG/$example/");</script>
          </head>
          <body>
            <p>Redirecting to <a href="/polen/$SEMVER_TAG/$example/">/polen/$SEMVER_TAG/$example/</a>...</p>
          </body>
          </html>
          EOF
          done

      - name: Commit and deploy
        run: |
          cd gh-pages
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          if [[ -n $(git status --porcelain) ]]; then
            git commit -m "chore: update ${{ steps.dist-tag.outputs.tag_name }} redirect to ${{ steps.dist-tag.outputs.semver_tag }}"
            git push origin gh-pages
          else
            echo "No changes to deploy"
          fi