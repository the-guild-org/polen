name: demos-preview

on:
  workflow_call:
    inputs:
      action:
        description: "The PR action (opened, synchronize, reopened, closed)"
        required: true
        type: string
      pr-number:
        description: "Pull request number"
        required: true
        type: number
      head-ref:
        description: "Head branch reference"
        required: false
        type: string
      head-sha:
        description: "Head commit SHA"
        required: false
        type: string

concurrency:
  group: pr-preview-${{ inputs.pr-number }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write
  deployments: write

jobs:
  deploy:
    if: inputs.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build Polen
        run: pnpm build

      - name: Re-install to link workspace packages
        run: pnpm install

      - name: Build demos landing page
        run: node ./scripts/build-demos-index.ts --basePath "/polen/pr-${{ inputs.pr-number }}/" --prNumber "${{ inputs.pr-number }}" --currentSha "${{ inputs.head-sha }}"

      - name: Build demos
        run: |
          # Get list of examples that are enabled for demos
          EXAMPLES=$(node --no-warnings ./.github/scripts/tools/get-demo-examples.ts)
          echo "Found demo-enabled examples: $EXAMPLES"

          # Build once for the commit-specific path
          for example in $EXAMPLES; do
            echo "Building $example demo..."
            pnpm --dir examples/$example build --base "/polen/pr-${{ inputs.pr-number }}/${{ inputs.head-sha }}/$example/"
          done

      - name: Prepare PR preview for deployment
        uses: ./.github/actions/run-workflow-step
        with:
          step: demos-preview/prepare-pr-deployment.ts
          inputs: |
            {
              "pr_number": "${{ inputs.pr-number }}",
              "head_sha": "${{ inputs.head-sha }}",
              "head_ref": "${{ inputs.head-ref }}"
            }

      - name: Update Demos Home
        uses: ./.github/actions/run-workflow-step
        with:
          step: shared/update-demos-home.ts
          inputs: |
            {
              "mode": "pr-index",
              "output_dir": "gh-pages-deploy"
            }

      - name: Debug - Check working directory and files
        run: |
          echo "Current working directory: $(pwd)"
          echo "---"
          echo "Files in current directory:"
          ls -la
          echo "---"
          echo "Looking for gh-pages-deploy:"
          find . -name "gh-pages-deploy" -type d 2>/dev/null | head -10
          echo "---"
          echo "Looking for dist-demos:"
          find . -name "dist-demos" -type d 2>/dev/null | head -10

      - name: Debug - List gh-pages-deploy contents
        run: |
          echo "Contents of gh-pages-deploy:"
          find gh-pages-deploy -type f | head -20
          echo "---"
          echo "Directory structure:"
          tree gh-pages-deploy -L 3 || ls -la gh-pages-deploy/

      - name: Verify deployment directory is not empty
        run: |
          if [ ! -d "gh-pages-deploy" ]; then
            echo "Error: gh-pages-deploy directory does not exist"
            exit 1
          fi

          file_count=$(find gh-pages-deploy -type f | wc -l)
          if [ "$file_count" -eq 0 ]; then
            echo "Error: gh-pages-deploy directory is empty (no files found)"
            exit 1
          fi

          echo "✅ Found $file_count files to deploy"

          # Verify PR-specific directory exists
          if [ ! -d "gh-pages-deploy/pr-${{ inputs.pr-number }}" ]; then
            echo "Error: PR directory gh-pages-deploy/pr-${{ inputs.pr-number }} does not exist"
            exit 1
          fi

          pr_file_count=$(find "gh-pages-deploy/pr-${{ inputs.pr-number }}" -type f | wc -l)
          if [ "$pr_file_count" -eq 0 ]; then
            echo "Error: PR directory is empty (no files found)"
            exit 1
          fi

          echo "✅ Found $pr_file_count files in PR directory"

      - name: Deploy to GitHub Pages
        uses: ./.github/actions/gh-pages-with-deployments
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-deploy
          destination_dir: .
          keep_files: true # Keep existing PR previews
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          commit_message: "Add pull request #${{ inputs.pr-number }} commit ${{ inputs.head-sha }}"
          pr_number: ${{ inputs.pr-number }}
          deployment_url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ inputs.pr-number }}/

      - name: Get previous deployments for this PR
        id: get-prev-pr-deployments
        uses: ./.github/actions/run-workflow-step
        with:
          step: demos-preview/get-previous-pr-deployments.ts
          inputs: |
            {
              "pr_number": "${{ inputs.pr-number }}",
              "current_sha": "${{ inputs.head-sha }}"
            }

      - name: Generate demo links
        id: demo-links
        uses: ./.github/actions/run-workflow-step
        with:
          step: demos-preview/generate-demo-links.ts
          inputs: |
            {
              "pr_number": "${{ inputs.pr-number }}",
              "head_sha": "${{ inputs.head-sha }}",
              "github_repository_owner": "${{ github.repository_owner }}",
              "github_repository_name": "${{ github.event.repository.name }}",
              "previous_deployment_links": "${{ steps.get-prev-pr-deployments.outputs.deployment_links }}"
            }

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ inputs.pr-number }}
          comment-author: "github-actions[bot]"
          body-includes: "## Demos Preview"

      - name: Comment on PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ inputs.pr-number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ## Demos Preview

            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ inputs.pr-number }}/

            ${{ steps.demo-links.outputs.links }}
